function Create-VulnTemplate {
    param(
        [string]$TemplateName,
        [string]$DisplayName,
        [string[]]$EKUs,
        [bool]$EnrolleeSuppliesSubject = $true,
        [bool]$RequiresManagerApproval = $false,
        [bool]$PublishToCA = $true
    )

    Write-Host "`n[*] Creating vulnerable template: $TemplateName" -ForegroundColor Cyan

    $config = (Get-ADRootDSE).ConfigurationNamingContext
    $templatePath = "CN=$TemplateName,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,$config"

    try {
        $obj = [ADSI]"LDAP://$templatePath"

        if (-not $obj) {
            Write-Host "[!] Failed to bind to template: $TemplateName" -ForegroundColor Red
            return
        }

        # Flags
        $flags = 0
        if ($EnrolleeSuppliesSubject) { $flags = $flags -bor 0x10 } # ENROLLEE_SUPPLIES_SUBJECT
        if ($RequiresManagerApproval) { $flags = $flags -bor 0x1 } # MANAGER_APPROVAL

        $obj.Put("pKIEnrollmentFlag", $flags)
        $obj.Put("displayName", $DisplayName)
        $obj.Put("pKIExtendedKeyUsage", $EKUs)

        $obj.SetInfo()

        if ($PublishToCA) {
            $ca = Get-CertificationAuthority
            certutil -config "$env:COMPUTERNAME\$($ca.Name)" -SetCATemplates +$TemplateName
        }

    } catch {
        Write-Host "[!] Error creating template: $_" -ForegroundColor Red
    }
}

# Install Web Enrollment (for ESC4 / relay attacks)
Install-WindowsFeature ADCS-Web-Enrollment -IncludeManagementTools

# ESC1 - Enrollee supplies subject name
Create-VulnTemplate -TemplateName "ESC1" -DisplayName "ESC1 User Template" -EKUs @(
    "1.3.6.1.5.5.7.3.2" # Client Authentication
) -EnrolleeSuppliesSubject $true

# ESC8 - SmartCard logon
Create-VulnTemplate -TemplateName "ESC8" -DisplayName "ESC8 SmartCard Logon" -EKUs @(
    "1.3.6.1.4.1.311.20.2.2", # Smartcard Logon
    "1.3.6.1.5.5.7.3.2"       # Client Authentication
) -EnrolleeSuppliesSubject $true

# ESC6 - Add enroll permissions on CA to Domain Users (weak ACL)
$ca = Get-CertificationAuthority
Add-CertificateAuthorityAcl -Name $ca.Name -Account "Domain Users" -AccessType Enroll

Write-Host "`n[+] Vulnerable ADCS lab deployed with ESC1, ESC6, ESC8 attack vectors ready." -ForegroundColor Green
