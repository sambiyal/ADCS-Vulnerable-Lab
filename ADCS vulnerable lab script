# Fully Patched ADCS Vulnerable Lab Script
# Target: Domain Controller (Server 2022)
# Goal: Install ADCS & enable ESC1 - ESC8

# Ensure script runs as admin
if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole('Administrator')) {
    Write-Error "Run this script as Administrator."
    exit
}

Import-Module ServerManager

function Ensure-ADCSInstalled {
    Write-Host "[*] Checking ADCS roles..." -ForegroundColor Cyan
    $caInstalled = Get-WindowsFeature -Name ADCS-Cert-Authority | Where-Object {$_.InstallState -eq "Installed"}
    $webEnrollInstalled = Get-WindowsFeature -Name ADCS-Web-Enrollment | Where-Object {$_.InstallState -eq "Installed"}

    if (-not $caInstalled) {
        Write-Host "[*] Installing ADCS Certification Authority..." -ForegroundColor Yellow
        Install-WindowsFeature ADCS-Cert-Authority -IncludeManagementTools
        Install-AdcsCertificationAuthority -CAType EnterpriseRootCA -CryptoProviderName "RSA#Microsoft Software Key Storage Provider" `
            -HashAlgorithmName SHA256 -KeyLength 2048 -ValidityPeriod Years -ValidityPeriodUnits 10 -CACommonName "VulnLabCA" -Force
    } else {
        Write-Host "[+] ADCS CA already installed." -ForegroundColor Green
    }

    if (-not $webEnrollInstalled) {
        Write-Host "[*] Installing Web Enrollment..." -ForegroundColor Yellow
        Install-WindowsFeature ADCS-Web-Enrollment -IncludeManagementTools
        Install-AdcsWebEnrollment -Force
    } else {
        Write-Host "[+] Web Enrollment already installed." -ForegroundColor Green
    }

    Restart-Service CertSvc
}

function Install-PSPKIIfMissing {
    if (-not (Get-Module -ListAvailable -Name PSPKI)) {
        Write-Host "[*] Installing PSPKI module..." -ForegroundColor Cyan
        Install-PackageProvider -Name NuGet -Force -Scope AllUsers
        Install-Module PSPKI -Force -AllowClobber
    }
    Import-Module PSPKI
}

function Enable-SANInjection {
    $caName = (Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration").'Active'
    $caPath = "HKLM:\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\$caName"
    Set-ItemProperty -Path $caPath -Name "EditFlags" -Value 0x40000
    Restart-Service CertSvc
    Write-Host "[+] Enabled SAN Injection (ESC5/ESC7)." -ForegroundColor Green
}

function Create-CertTemplate {
    param(
        [string]$Name,
        [string[]]$EKUs,
        [int]$Flags = 0x10
    )

    Write-Host "[*] Creating template $Name..." -ForegroundColor Cyan

    certutil -v -dstemplate User $Name | Out-Null
    Start-Sleep -Seconds 2

    $config = (Get-ADRootDSE).ConfigurationNamingContext
    $path = "CN=$Name,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,$config"
    $template = [ADSI]("LDAP://$path")

    try {
        $template.Put("displayName", $Name)
        $template.Put("pKIEnrollmentFlag", $Flags)
        $template.PutEx(2, "pKIExtendedKeyUsage", $EKUs)
        $template.SetInfo()
        certutil -setcatemplates +$Name | Out-Null
        Write-Host "[+] Template $Name created and published." -ForegroundColor Green
    } catch {
        Write-Warning ("[-] Failed to create or update template {0}: {1}" -f $Name, $_)
    }
}

function Add-TemplatePermission {
    param (
        [string]$TemplateName,
        [string]$UserGroup = "Domain Users"
    )

    $config = (Get-ADRootDSE).ConfigurationNamingContext
    $ldap = "CN=$TemplateName,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,$config"
    $acl = Get-Acl -Path ("AD:\" + $ldap)
    $rule = New-Object System.DirectoryServices.ActiveDirectoryAccessRule(
        ([System.Security.Principal.NTAccount]$UserGroup),
        "GenericAll",
        "Allow"
    )
    $acl.AddAccessRule($rule)
    Set-Acl -Path ("AD:\" + $ldap) -AclObject $acl
    Write-Host "[+] Granted GenericAll on $TemplateName to $UserGroup" -ForegroundColor Yellow
}

function Add-CAEnrollACL {
    $ca = Get-CertificationAuthority
    Add-CertificateAuthorityAcl -Name $ca.Name -Account "Domain Users" -AccessType Enroll
    Write-Host "[+] Added Enroll permission to Domain Users on CA (ESC6)." -ForegroundColor Yellow
}

function Validate-Templates {
    Write-Host "[*] Validating published templates..." -ForegroundColor Cyan
    certutil -CATemplates
    certutil -CAInfo
}

# ----------------------
# Run Setup
# ----------------------

Ensure-ADCSInstalled
Install-PSPKIIfMissing
Enable-SANInjection

Create-CertTemplate -Name "ESC1" -EKUs @("1.3.6.1.5.5.7.3.2") -Flags 0x10
Create-CertTemplate -Name "ESC2" -EKUs @("1.3.6.1.5.5.7.3.2") -Flags 0x10
Add-TemplatePermission -TemplateName "ESC2"

Create-CertTemplate -Name "ESC3" -EKUs @("1.3.6.1.5.5.7.3.2") -Flags 0x10
Create-CertTemplate -Name "ESC4_Ready" -EKUs @("1.3.6.1.5.5.7.3.2") -Flags 0x10
Create-CertTemplate -Name "ESC5_ESC7" -EKUs @("1.3.6.1.5.5.7.3.2") -Flags 0x10
Add-CAEnrollACL

Create-CertTemplate -Name "ESC8" -EKUs @("1.3.6.1.4.1.311.20.2.2", "1.3.6.1.5.5.7.3.2") -Flags 0x10

Validate-Templates
Write-Host "`n[âœ”] ADCS Vulnerable Lab Deployed on Domain Controller (ESC1 - ESC8)." -ForegroundColor Green
